<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Vietnamese TTS ‚Äì iOS Safari Optimized</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* Thi·∫øt k·∫ø t·ªëi ∆∞u cho di ƒë·ªông (Mobile-First Design) */
:root{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --accent:#2563eb;
}
.light{
  --bg:#f3f4f6;
  --card:#ffffff;
  --text:#111827;
}
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height: 100vh; 
  padding: 15px; 
}
.app{
  width: 100%; 
  max-width:780px;
  background:var(--card);
  padding:20px;
  border-radius:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}
h2 {
    font-size: 20px;
    margin-top: 0;
}
textarea{
  width:100%;
  height:150px;
  font-size:17px;
  padding:15px;
  box-sizing: border-box;
  border-radius: 8px;
  border: 1px solid #334155;
  background: #000;
  color: var(--text);
  resize: none;
}
.controls{
  display:flex;
  flex-direction: column; 
  gap:15px; 
  margin-top:15px;
}
.main-actions {
    display: flex;
    flex-direction: column; 
    gap: 10px;
    width: 100%;
}
.settings-row {
    display: flex;
    gap: 10px;
    width: 100%;
    flex-wrap: wrap; 
}

button, select, label {
  padding:14px 16px; 
  border-radius:10px;
  border:none;
  font-size:17px; 
  box-sizing: border-box;
  text-align: center;
}
button{
  background:var(--accent);
  color:#fff;
  cursor:pointer;
  transition:transform .06s,box-shadow .06s;
}
button:active{
  transform:scale(.96);
  box-shadow:inset 0 3px 6px rgba(0,0,0,.3);
}
button:disabled{
  opacity:.45;
  cursor:not-allowed;
}

.main-actions button {
    width: 100%;
}

label {
    display: flex;
    flex-direction: column; 
    align-items: center;
    background: #202d44; 
    padding: 12px;
    flex-grow: 1; 
}

label input[type="range"] {
    width: 100%;
    margin-top: 5px;
}

select#voice, #theme {
    flex-grow: 1;
    min-width: 100px; 
    background: #334155;
    color: var(--text);
}

.progress{
  height:8px;
  background:#334155;
  border-radius:6px;
  overflow:hidden;
  margin-top:12px;
}
.bar{
  height:100%;
  width:0%;
  background:#22c55e;
  transition:width .15s linear;
}
.status{
  margin-top:6px;
  font-size:13px;
}
</style>
</head>

<body>
<div class="app">
<h2>üîä Vietnamese TTS ‚Äì Safari Ready</h2>

<textarea id="txt">
Ch√†o m·ª´ng b·∫°n. Gi·ªçng ƒë·ªçc n√†y ƒëang s·ª≠ d·ª•ng gi·ªçng ƒë·ªçc ti·∫øng Vi·ªát t√≠ch h·ª£p c·ªßa Apple. Ch√∫ng t√¥i ƒë√£ x·ª≠ l√Ω c√°c v·∫•n ƒë·ªÅ v·ªÅ ng·∫Øt c√¢u v√† s·ªë th·∫≠p ph√¢n (v√≠ d·ª•: 10.5) ƒë·ªÉ t·ªëi ∆∞u h√≥a tr·∫£i nghi·ªám ƒë·ªçc cho b·∫°n.
</textarea>

<div class="controls">
<select id="voice"></select>

<div class="settings-row">
    <label>Rate (Max Speed)
    <input id="rate" type="range" min="0.7" max="1.3" step="0.1" value="1.3" disabled> 
    </label>

    <label>Pitch
    <input id="pitch" type="range" min="0.8" max="1.4" step="0.1" value="1">
    </label>
    
    <button id="theme">üåó Theme</button>
</div>

<div class="main-actions">
    <button id="play">‚ñ∂ Speak</button> 
    <button id="stop" disabled>‚èπ Stop Speaking</button>
</div>

</div>

<div class="progress">
  <div class="bar" id="bar"></div>
</div>
<div class="status" id="status">Status: Ready</div>
</div>

<script>
// Bi·∫øn tr·∫°ng th√°i
let voices=[];
let sentences=[];
let index=0;
let speaking=false;
let timer=null; 

const statusEl=document.getElementById("status");
const bar=document.getElementById("bar");
const txt = document.getElementById("txt");
const voice = document.getElementById("voice");
const rate = document.getElementById("rate"); 
const pitch = document.getElementById("pitch");
const play = document.getElementById("play");
const stop = document.getElementById("stop");


/* LOAD VOICES */
speechSynthesis.onvoiceschanged=()=>{
  // L·ªçc l·∫•y gi·ªçng ti·∫øng Vi·ªát
  voices=speechSynthesis.getVoices().filter(v=>v.lang==="vi-VN");
  voice.innerHTML="";
  if (voices.length === 0) {
      statusEl.textContent = "Error: No Vietnamese voices found on this device.";
      return;
  }
  voices.forEach((v,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.text=v.name;
    voice.appendChild(o);
  });
};

/* UTILS - L√µi t·ªëi ∆∞u h√≥a ng·∫Øt c√¢u v√† d·∫•u th·∫≠p ph√¢n */
function splitText(){ 
  let text = txt.value;
  
  // 1. Thay th·∫ø T·∫§T C·∫¢ d·∫•u ch·∫•m (.) th√†nh d·∫•u ph·∫©y (,)
  // Vi·ªác n√†y bu·ªôc TTS ƒë·ªçc 10.5 l√† "m∆∞·ªùi ph·∫©y nƒÉm" v√† lo·∫°i b·ªè d·∫•u ch·∫•m c√¢u c·ª©ng.
  text = text.replace(/\./g, ','); 
  
  // 2. Thay th·∫ø d·∫•u ph·∫©y ng·ªØ ph√°p (n·∫øu c√≤n) b·∫±ng d·∫•u ng·∫Øt m·ªÅm ( ‚Äì ) 
  text = text.replace(/,/g, ' ‚Äì '); 
  
  // 3. Chia vƒÉn b·∫£n th√†nh c√°c c√¢u. Ch·ªâ d√πng d·∫•u ch·∫•m than (!) v√† h·ªèi (?) ƒë·ªÉ ng·∫Øt c√¢u.
  // D·∫•u ch·∫•m c√¢u ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü b∆∞·ªõc 1 v√† 2.
  let raw_sentences = text.match(/[^!?]+[!?]*/g) || [];
  
  let final_sentences = raw_sentences.map(s => {
      s = s.trim();
      // Lo·∫°i b·ªè d·∫•u ch·∫•m h·ªèi/than cu·ªëi c√πng ƒë·ªÉ ngƒÉn TTS d·ª´ng qu√° l√¢u
      s = s.replace(/[!?]$/, ''); 
      return s;
  }).filter(s => s.length > 0);
  
  return final_sentences; 
}

function updateProgress(){ bar.style.width = Math.round(index/sentences.length*100) + "%"; }

/* SPEAK */
function speakNext(){
  if(!speaking || !voices.length) return;
  if(index>=sentences.length){ finishSpeak(); return; }
  speechSynthesis.cancel(); 

  const u=new SpeechSynthesisUtterance(sentences[index]);
  u.voice=voices[voice.value];
  
  // T·ªëc ƒë·ªô ƒë∆∞·ª£c ƒë·∫∑t l√† gi√° tr·ªã max (1.3) ƒë·ªÉ ƒë·ªçc li·ªÅn m·∫°ch h∆°n
  u.rate = parseFloat(rate.value); 
  
  u.pitch=parseFloat(pitch.value);
  statusEl.textContent="Speaking: "+sentences[index].slice(0,40).trim()+"...";

  u.onend=()=>{
    if(!speaking) return; 
    index++;
    updateProgress();
    // Th·ªùi gian ch·ªù l√† 0ms ƒë·ªÉ ph√°t c√¢u ti·∫øp theo ngay l·∫≠p t·ª©c 
    timer = setTimeout(()=>{ if(speaking) speakNext(); }, 0); 
  };
  
  u.onerror = (e) => {
    if(speaking) { 
        console.error("TTS Speaking Error:", e);
        finishSpeak(true); 
    }
  }
  speechSynthesis.speak(u);
}

/* SPEAK CONTROL */
function finishSpeak(wasStopped=false){
  speechSynthesis.cancel(); 
  speaking=false;
  if(timer) { clearTimeout(timer); timer = null; }
  play.disabled=false;
  stop.disabled=true; 

  if(wasStopped){ 
      statusEl.textContent="Status: Speaking stopped";
  } else { 
      bar.style.width="100%"; 
      statusEl.textContent="Status: Finished speaking";
  }
}

/* PLAY BUTTON */
play.onclick=()=>{
  if(timer) clearTimeout(timer);
  speechSynthesis.cancel();
  
  sentences=splitText(); 
  if(!sentences.length || !voices.length) {
    statusEl.textContent = "Error: No text or no Vietnamese voices found.";
    return;
  }

  // Tr√™n iOS/Safari, vi·ªác g·ªçi speechSynthesis.speak() ph·∫£i ƒë∆∞·ª£c g·ªçi t·ª´ m·ªôt h√†m 
  // k√≠ch ho·∫°t b·ªüi t∆∞∆°ng t√°c ng∆∞·ªùi d√πng (nh∆∞ s·ª± ki·ªán click n√†y) ƒë·ªÉ ho·∫°t ƒë·ªông.
  index=0;
  bar.style.width="0%";
  speaking=true;
  play.disabled=true;
  stop.disabled=false; 
  statusEl.textContent="Status: Speaking‚Ä¶";
  speakNext();
};

stop.onclick=()=>{
  speaking = false;
  finishSpeak(true);
};


/* THEME */
theme.onclick=()=>{
  document.body.classList.toggle("light");
};
</script>
</body>
</html>
